{{>/layout/main-header}}

<head>
    <link rel="stylesheet" href="/css/join-form.css">
</head>
<style>
    .btn-outline-info {
        border: 1px solid #1EB49F;
        color: #1EB49F;
    }
    .btn-outline-info:hover {
        background-color: #1EB49F;
    }
</style>

<div class="container">
    <div class="my_auth_box">
        <div class="my_auth_form_box">
            <div class="my_auth_form_box_title d-flex justify-content-center">
                <img src="/upload/newLogo.png" style="width: 250px; height: 100px">
            </div>
            <div class="my_error_box my_hidden">

            </div>
            <form id="joinForm">
                <input id="username" class="my_auth_form_box_input" type="text" name="username" placeholder="ìœ ì €ë„¤ì„"
                       maxlength="20" value="" required/>
                <div id="usernameDuplicatedText" class="my_hidden" style="color: red">ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.</div>
                <div id="usernameNoDuplicatedText" class="my_hidden" style="color: green">ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.</div>

                <input id="password" class="my_auth_form_box_input" type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
                       maxlength="20" value="" required/>

                <input id="samePassword" class="my_auth_form_box_input" type="password" name="" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                       maxlength="20" value="" required/>
                <div id="errorTextBox" style="color: red">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                <div id="successTextBox" style="color: green">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.</div>

                <div class="email-container">
                    <input class="my_auth_form_box_input" id="email" type="email" name="email" placeholder="ì´ë©”ì¼"
                           maxlength="60"
                           value="" required/>
                    <button class="btn btn-outline-info btn-sm" type="button" id="emailAuthButton">ì¸ì¦í•˜ê¸°</button>
                </div>

                <button type="submit" id="joinBtn" class="my_secondary_btn">íšŒì›ê°€ì…</button>
            </form>
            <div class="my_auth_form_box_link">
                <div><a href="/login-form">ë¡œê·¸ì¸</a></div>
<!--                <div><a href="/user/password-reset-form">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a></div>-->
            </div>
        </div>
    </div>
    <br/>
</div>

<!-- ëª¨ë‹¬ì°½ êµ¬ì¡° -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <p style="font-size: 30px">ğŸ’Œ ë°œì†¡ ì™„ë£Œ ğŸ’Œ</p>
        <input type="text" id="authCodeText" placeholder="ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
        <div class="modal-buttons">
            <button id="cancelBtn">ì·¨ì†Œ</button>
            <button id="confirmBtn">í™•ì¸</button>
        </div>
    </div>
</div>


<script>

    // ëª¨ë‹¬ì°½ì„ ë³´ì´ê²Œ í•˜ëŠ” í•¨ìˆ˜
    function showModal() {
        $('#authCodeText').val('');
        $('#authModal').css('display', 'block');
    }

    // "ì¸ì¦í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ ë³´ë‚´ê¸° ëª¨ë‹¬ì°½ ë³´ì´ê¸°
    $('#emailAuthButton').on('click', function () {
        emailSendCode();
    });

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì°½ ë‹«ê¸°
    $('#cancelBtn').on('click', function () {
        $('#authModal').css('display', 'none');
        // ì¸ì¦ ì½”ë“œ ì…ë ¥ë€ ì´ˆê¸°í™”
    });
    // ëª¨ë‹¬ì°½ ìŠ¤í¬ë¦½íŠ¸ ë

    <!-- ì´ë©”ì¼ ì£¼ì†Œë¡œ ë©”ì¼ ë³´ë‚´ê¸° -->
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
    let emailCode;

    function emailSendCode() {
        console.log($("#email").val());
        let email = encodeURIComponent($("#email").val());

        $.ajax({
            url: '/send-mail?email=' + email,
            type: 'GET'

        }).done((res) => {
            // console.log("Res " + JSON.stringify(res));
            emailCode = res.body;
            console.log("ë³´ë‚¸ ì½”ë“œ " + emailCode);
            showModal();

        }).fail((res) => {
            alert("ì˜¤ë¥˜");
        });

    }

    // ë©”ì¼ ë³´ë‚´ê¸° ë


    // ì¸ì¦ë²ˆí˜¸ í™•ì¸ ë¡œì§
    let isEmailConfirmed = false;

    $("#confirmBtn").click(function () {

        let checkEmailCode = $("#authCodeText").val();
        // console.log("ì…ë ¥ ì½”ë“œ " + checkCode);

        $.ajax({
            url: '/check-email-code?emailCode=' + checkEmailCode,
            type: 'GET'

        }).done((res)=>{
            if (res.body) {
                Swal.fire({
                    title: "ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                    icon: "success",
                    button: "í™•ì¸"
                });
                $('#authModal').css('display', 'none');
                isEmailConfirmed = true;

            } else {
                Swal.fire({
                    title: "ì¸ì¦ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
                    icon: "warning",
                    button: "í™•ì¸"
                });
                $('#authModal').css('display', 'block');
            }

        }).fail((res) => {
            alert("ì˜¤ë¥˜");
        });

    });

    // ì¸ì¦ë²ˆí˜¸ í™•ì¸ ë¡œì§ ë


    <!--username ì¤‘ë³µ ì²´í¬ -->
    // keyup - debounce (í•œë²ˆì— ëª¨ì•˜ë‹¤ê°€ ì¼ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ ë³´ë‚¸ë‹¤)
    $("#username").on("keyup", _.debounce(function () {
        console.log($(this).val());
        let username = $(this).val();

        $.ajax({
            url: '/username-check?username=' + username,
            type: 'GET'

        }).done((res) => {
            // console.log("Res " + JSON.stringify(res));

            if (res.body === "USER_EXIST") {
                showUsernameDuplicatedText();
                hideUsernameSuccessText();
            }

            if (res.body === "USER_NO_EXIST") {
                hideUsernameDuplicatedText();
                showUsernameSuccessText();
            }

            if ((username) === "") {
                hideUsernameSuccessText();
                hideUsernameDuplicatedText();
            }

        }).fail((res) => {
            alert("ì˜¤ë¥˜");
        });

    }, 300));

    // username ì¤‘ë³µ ì²´í¬ ë


    <!--    ë¹„ë°€ë²ˆí˜¸ ë™ì¼ ì²´í¬ -->
    hideErrorTextBox();
    hideSuccessTextBox();

    $("#samePassword").on("input", function () {
        let password = $("#password").val();
        // console.log("íŒ¨ìŠ¤ì›Œë“œ = " + password);

        let confirmPassword = $("#samePassword").val();
        // console.log("í™•ì¸ìš© = " + confirmPassword);

        if (password === confirmPassword) {
            showSuccessTextBox();
            hideErrorTextBox();
            $("#joinBtn").css("background-color", "green");

            // ê°’ì„ ë‹¤ ì§€ì› ìœ¼ë©´ ë‹¤ì‹œ ë‘˜ ë‹¤ my_hidden ë„£ì–´ì¤˜ì•¼í•¨
        } else if (confirmPassword === "") {
            hideErrorTextBox();
            hideSuccessTextBox();
            $("#joinBtn").css("background-color", "");

        } else {
            showErrorTextBox();
            hideSuccessTextBox();
            $("#joinBtn").css("background-color", "");
        }
    });
    // ë¹„ë°€ë²ˆí˜¸ ë™ì¼ì²´í¬ ë



//ì´ë©”ì¼ì„ ë‹¤ë¥¸ê±¸ë¡œ ë°”ê¾¸ë©´ isEmailConfirmed ê°’ì„ ë‹¤ì‹œ falseë¡œ ë°”ê¿”ì¤˜ì•¼í•  ê²ƒ ê°™ìŒ
    $("#email").on("input", function () {
        isEmailConfirmed = false;
        // console.log("isEmailConfirmed " + isEmailConfirmed);
    });


    // ì´ë©”ì¼ ì¸ì¦ ì•ˆë˜ë©´ ë§‰ê¸° + ë¹„ë²ˆì´ ë‹¤ë¥´ë©´ form ì œì¶œ ëª»í•˜ê²Œ ë§‰ì•„ë†“ìŒ
    $("#joinForm").on("submit", function (e) {
        //í¼ ë§‰ê¸°
        e.preventDefault();

        // console.log("1");

        //íŒ¨ìŠ¤ì›Œë“œ ìœ íš¨ì„± ê²€ì‚¬
        if (!passwordValid()) {
            return;
        }

        // í¼ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
        let serializedDataArray = $("#joinForm").serializeArray();
        serializedDataArray.push({ name: 'isEmailConfirmed', value: isEmailConfirmed });

        // URL-encoded ë¬¸ìì—´ë¡œ ë³€í™˜
        let serializedData = $.param(serializedDataArray);

        console.log("3");

        $.ajax({
            url: "/join",
            data: serializedData,
            contentType: "application/x-www-form-urlencoded",
            processData: true,
            type: 'POST'

        }).done((res)=>{
            console.log("4");

            Swal.fire({
                title: "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                icon: "success",
                button: "í™•ì¸"
            });

            window.location.href = "/";

        }).fail((res)=>{
            console.log("5");

            Swal.fire({
                title: res.responseJSON.msg,
                icon: "warning",
                button: "í™•ì¸"
            });
        });

    });
    // ì´ë©”ì¼ ì¸ì¦ ì•ˆë˜ë©´ ë§‰ê¸° + ë¹„ë²ˆì´ ë‹¤ë¥´ë©´ form ì œì¶œ ëª»í•˜ê²Œ ë§‰ì•„ë†“ìŒ ë


    // ìœ ì € ë„¤ì„ ì¤‘ë³µì²´í¬
    function hideUsernameDuplicatedText() {
        $("#usernameDuplicatedText").addClass("my_hidden");
    }

    function hideUsernameSuccessText() {
        $("#usernameNoDuplicatedText").addClass("my_hidden");
    }

    function showUsernameSuccessText() {
        $("#usernameNoDuplicatedText").removeClass("my_hidden");
    }

    function showUsernameDuplicatedText() {
        $("#usernameDuplicatedText").removeClass("my_hidden");
    }
//     ìœ ì €ë„¤ì„ ì¤‘ë³µì²´í¬ ë


    // ë¹„ë°€ë²ˆí˜¸ ë™ì¼ ì²´í¬
    function hideErrorTextBox() {
        $("#errorTextBox").addClass("my_hidden");
    }

    function hideSuccessTextBox() {
        $("#successTextBox").addClass("my_hidden");
    }

    function showErrorTextBox() {
        $("#errorTextBox").removeClass("my_hidden");
    }

    function showSuccessTextBox() {
        $("#successTextBox").removeClass("my_hidden");
    }
//     ë¹„ë°€ë²ˆí˜¸ ë™ì¼ ì²´í¬ ë

    // íŒ¨ìŠ¤ì›Œë“œ ìœ íš¨ì„± ê²€ì‚¬
    function passwordValid() {
        let password = $("#password").val();
        // console.log("íŒ¨ìŠ¤ì›Œë“œ = " + password);

        let confirmPassword = $("#samePassword").val();
        // console.log("í™•ì¸ìš© = " + confirmPassword);

        if (password !== confirmPassword) {
            Swal.fire({
                title: "ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
                icon: "warning",
                button: "í™•ì¸"
            });

            return false;

        } else if (confirmPassword === "") {
            Swal.fire({
                title: "ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
                icon: "warning",
                button: "í™•ì¸"
            });

            return false;
        }

        return true;
    }
    // íŒ¨ìŠ¤ì›Œë“œ ìœ íš¨ì„±ê²€ì‚¬ ë

</script>


{{>/layout/footer}}