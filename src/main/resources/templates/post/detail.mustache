{{>/layout/main-header}}

<style>
    .btn-outline-info {
        border: 1px solid #1EB49F;
        color: #1EB49F;
    }

    .btn-outline-info:hover {
        background-color: #1EB49F;
    }

    .replyUpdateBtn {
        background-color: #1EB49F;
    }

    .replyUpdateBtn:hover {
        background-color: #159f8c;
    }

</style>

<div class="container">
    <input id="postId" type="hidden" value="{{model.postId}}"/>
    <input id="pageOwnerId" type="hidden" value="1"/>
    <input id="my-loveId" type="hidden" value="1">


    <div class="my_post_detail_title">
        <h2>{{model.title}}</h2>
        <span>ì‘ì„±ì¼ : {{model.createdAt}}</span>
    </div>
    <hr/>

    <div class="my_post_detail_content">
        {{{model.content}}}
    </div>

    <br><br>

    <div class="my_post_info_box d-flex">
        <div class="my_post_info">
            <i class="fa-solid fa-heart my_fake_like my_mr_sm_1" id="heart-1"></i>
            by <b>{{model.username}}</b> <span class="my_text_body_sm"></span>

            <!--            <i class="far fa-heart my_fake_un_like my_mr_sm_1" id="my-heart"></i>-->
            <!--            by <b>ìœ ì €ë„¤ì„</b> <span class="my_text_body_sm">ë‚ ì§œ</span>-->

        </div>
    </div>

    {{#model.isPostOwner}}
        <div class="my_mt_md_1">
            <a class="btn btn-outline-info" href="/s/post/update-form/{{model.postId}}">ìˆ˜ì •</a>
            <button id="btn-delete" class="btn btn-outline-danger">ì‚­ì œ</button>
        </div>
    {{/model.isPostOwner}}

    <br/>
    <hr>

    <!-- ëŒ“ê¸€ -->
    <div class="card mt-3">
        <!-- ëŒ“ê¸€ë“±ë¡ -->
        <div class="card-body">
            <!--            <form action="/reply/save" method="post">-->
            <input id="postId" type="hidden" name="postId" value="{{model.postId}}">
            <textarea id="comment" class="form-control" rows="2" name="comment"></textarea>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-outline-info mt-1" onclick="replySave()">
                    ëŒ“ê¸€ë“±ë¡
                </button>
            </div>
            <!--            </form>-->
        </div>

        <!-- ëŒ“ê¸€ëª©ë¡ -->
        <div class="card-footer">
            <b>ëŒ“ê¸€ë¦¬ìŠ¤íŠ¸</b>
        </div>
        <div class="list-group">
            <div id="replyList"></div>
        </div>
        <!--       ëŒ“ê¸€ ì•„ì´í…œ  -->
    </div>

    <!--        ëŒ“ê¸€ í˜ì´ì§•-->
    <br>

    <div style="display: flex; justify-content: center;">
        <button type="button" class="btn btn-outline-info mt-1 replyPageLoad">
            +
        </button>
    </div>

    <br><br>

    <script>

<!--        ê²Œì‹œê¸€ idëŠ” ì „ì—­ë³€ìˆ˜-->
        const postId = $("#postId").val();
        console.log("postId ì „ì—­ = " + postId);

        <!--        ëŒ“ê¸€ ì‘ì„± -->
        function replySave() {
            let comment = $("#comment").val();
            // console.log("commentSave " + comment);
            // let postId = $("#postId").val();
            // console.log("postId " + postId);

            let commentSave = {
                comment: comment,
                postId: postId
            };

            $.ajax({
                url: '/a/reply/save',
                data: JSON.stringify(commentSave),
                contentType: 'application/json; charset=utf-8',
                type: 'POST'

            }).done((res) => {
                console.log("res ddd = " + JSON.stringify(res));
                console.log("msg = " + res.status);

                if (res.status === 400) {
                    Swal.fire({
                        title: res.msg,
                        icon: "warning",
                        button: "í™•ì¸"
                    });
                    return;
                }

                let reply = res.body;
                let replyItem = getReplyItem(reply);
                $("#replyList").prepend(replyItem);
                $("#comment").val('');
                replyLoad();

            }).fail((res) => {
                if (res.status === 401) {
                    const response = JSON.parse(res.responseText);

                    Swal.fire({
                        title: response.msg,
                        icon: "warning",
                        button: "í™•ì¸"
                    });

                } else {
                    alert("ì—ëŸ¬");
                }

            });
        }

        // ëŒ“ê¸€ ì‘ì„± ë


        // ëŒ“ê¸€ í˜ì´ì§•
        let page = 0;
        let totalPages = 0;

        replyLoad();

        $(".replyPageLoad").on('click', function () {
            // alert("dddd");

            if (page < totalPages - 1) {    // ë” ì´ìƒ í˜ì´ì§€ê°€ ì—†ì„ ë•Œê¹Œì§€
                page++;
                replyLoad();
            } else {
                Swal.fire({
                    title: "ë” ì´ìƒ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.",
                    icon: "warning",
                    button: "í™•ì¸"
                });
            }
        });


        // í˜ì´ì§• í•¨ìˆ˜ ë”°ë¡œ ë¹¼ê¸°
        function replyLoad() {
            // alert("dd");
            // let postId = $("#postId").val(); // í˜„ì¬ ê²Œì‹œê¸€ì˜ ID ê°€ì ¸ì˜¤ê¸°

            $.ajax({
                // postIdë¥¼ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ í˜•ì‹ìœ¼ë¡œ ë³´ë‚´ë²„ë¦¬ë©´ í•´ë‹¹í•˜ëŠ” ê²Œì‹œê¸€ì— ìˆëŠ” ëŒ“ê¸€ë§Œ ë‚˜ì˜¤ê²Œ í•  ìˆ˜ ìˆìŒ
                url: `/api/reply/list?postId=${postId}&page=${page}`,
                // ì„œë²„ì—ì„œ ë³´ë‚´ì¤€ ë°ì´í„°ê°€ JSON í˜•ì‹ì´ë¼ëŠ” ê²ƒì„ ì•Œë ¤ì¤Œ
                dataType: 'json'

            }).done((res) => {
                console.log("ì„±ê³µ", res);

                if (page === 0) {
                    $("#replyList").empty();
                }

                res.body.content.forEach((reply) => {
                    let replyItem = getReplyItem(reply);
                    $("#replyList").append(replyItem);
                });

                totalPages = res.body.totalPages;
                // console.log("totalPages " + totalPages);
                page = res.body.number;
                // console.log("page " + page);

            }).fail((res) => {
                console.log("ì‹¤íŒ¨", res);
            });
        }

        // í˜ì´ì§• í•¨ìˆ˜ ë”°ë¡œ ë¹¼ê¸°


        // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ csrìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        function getReplyItem(reply) {
            let isReplyOwner = reply.isReplyOwner; // ëŒ“ê¸€ ì†Œìœ ì ì—¬ë¶€ í™•ì¸
            let buttons = '';

            if (isReplyOwner) {
                buttons = `<div>
                    <button class="btn-sm btn-info replyUpdateBtn" id="reply-${reply.id}">ìˆ˜ì •</button>
                    <div class="d-inline-block">
                        <input id="postId" type="hidden" name="postId" value="${reply.postId}">
                        <input type="hidden" id="userId" name="userId" value="${reply.userId}">
                        <button class="btn replyDeleteBtn" data-reply-id="${reply.id}" onclick="replyDelete()">ğŸ—‘</button>
                    </div>
                </div>`;
            }

            let item = `<div id="showReplyUpdateForm-${reply.id}" class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex">
                            <div id="username-${reply.id}" data-username="${reply.username}" class="px-1 me-1 text-white rounded" style="margin-right: 10px; background-color: #1EB49F">
                                ${reply.username}
                            </div>
                            <div id="comment-${reply.id}">${reply.comment}</div>
                        </div>
                            ${buttons}
                        </div>`;

            return item;
        }

        // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ csrìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°


        // ëŒ“ê¸€ csr ì‚­ì œ
        function replyDelete() {
            let replyId = $(".replyDeleteBtn").data('reply-id');
            console.log("replyId " + replyId);

            let userId = $("#userId").val();
            console.log("userId " + userId);

            let replyDelete = {
                userId: userId,
                postId: postId
            };

            $.ajax({
                url: '/a/reply/delete/' + replyId,
                data: JSON.stringify(replyDelete),
                contentType: 'application/json; charset=utf-8',
                type: 'POST'

            }).done((res) => {
                console.log("ì„±ê³µ", res);
                $("#showReplyUpdateForm-" + replyId).remove();
                replyLoad();

            }).fail((res) => {
                if (res.responseJSON.status === 404) {
                    Swal.fire({
                        title: res.responseJSON.msg,
                        icon: "warning",
                        button: "í™•ì¸"
                    });
                }
                console.log("ì‹¤íŒ¨", res);
            });
        }

        // ëŒ“ê¸€ ì‚­ì œ


        <!-- ëŒ“ê¸€ ìˆ˜ì • ë·° ë„ìš°ê¸° -->
        $(document).on('click', '.replyUpdateBtn', function () {
            let replyId = $(this).attr('id').replace('reply-', '');
            console.log("reply " + replyId);

            // ì´ì „ì— ìƒì„±ëœ ìˆ˜ì • í¼ ì œê±°
            $(`#newShowReplyUpdateForm-${replyId}`).remove();

            let username = $("#username-" + replyId).data('username');
            console.log("username " + username);

            // let comment = $("#comment-" + replyId).data('reply');
            let comment = $("#comment-" + replyId).text();
            console.log("comment " + comment);

            // let postId = $("#postId").val();
            console.log("postId " + postId);

            let newElement = `<!--    ëŒ“ê¸€ ìˆ˜ì • ë·° -->
                            <input id="userId" type="hidden" name="userId" value="{{model.userId}}">
                            <div id="newShowReplyUpdateForm-${replyId}" class="list-group-item justify-content-between align-items-center reply-wrapper">
                                <div class="d-flex">
                                    <div class="px-1 me-1 text-white rounded" style="margin-right: 10px; background-color: #1EB49F">
                                        ${username}
                                    </div>
                                    <textarea class="form-control" rows="3" name="comment" id="reply-comment-${replyId}"
                                         style="width: 100%; height: 80px;">${comment}</textarea>
                                </div>
                                <div class="d-flex justify-content-end" style="margin-top: 5px;">
                                    <button class="btn-sm btn-success replyUpdateCompleteBtn" data-reply-id="${replyId}">ì™„ë£Œ</button>
                                    <button class="btn-sm btn-danger replyUpdateCancelBtn" data-reply-id="${replyId}">ì·¨ì†Œ</button>
                                </div>
                            </div>
                            <!--    ëŒ“ê¸€ ìˆ˜ì • ë·° -->`;

            $("#showReplyUpdateForm-" + replyId).hide();
            $("#showReplyUpdateForm-" + replyId).after(newElement);

        });
        // ëŒ“ê¸€ ìˆ˜ì • ë·° ë„ìš°ê¸° ë


        // reply update ajax ì‹œì‘
        $(document).on("click", ".replyUpdateCompleteBtn", function () {
            let replyId = $(this).data('reply-id');
            console.log("ë¦¬í”Œë¦¬ ì•„ì´ë”” " + replyId);

            // let postId = $("#postId").val();
            console.log("postId " + postId);

            let userId = $("#userId").val();
            console.log("userId " + userId);

            let updateComment = $("#reply-comment-" + replyId).val();
            console.log("updateComment " + updateComment);

            let replyUpdateData = {
                postId: postId,
                userId: userId,
                comment: updateComment
            };


            $.ajax({
                url: '/a/reply/update/' + replyId,
                data: JSON.stringify(replyUpdateData),
                contentType: 'application/json; charset=utf-8',
                type: 'POST'

            }).done((res) => {
                console.log("ì„±ê³µ", res);

                if (res.status === 400) {
                    Swal.fire({
                        title: res.msg,
                        icon: "warning",
                        button: "í™•ì¸"
                    });
                    return;
                }

                $("#newShowReplyUpdateForm-" + replyId).remove();
                let reply = res.body;
                let updateReplyItem = getReplyItem(reply);

                // ê¸°ì¡´ ëŒ“ê¸€ ì•„ì´í…œì„ ìƒˆë¡œ ìƒì„±ëœ ëŒ“ê¸€ ì•„ì´í…œìœ¼ë¡œ êµì²´
                $("#showReplyUpdateForm-" + replyId).replaceWith(updateReplyItem);

            }).fail((res) => {
                if (res.responseJSON.status === 404) {
                    Swal.fire({
                        title: res.responseJSON.msg,
                        icon: "warning",
                        button: "í™•ì¸"
                    });
                }
                console.log("ì‹¤íŒ¨", res);
            });

            if (res.status === 401) {
                const response = JSON.parse(res.responseText);

                Swal.fire({
                    title: response.msg,
                    icon: "warning",
                    button: "í™•ì¸"
                });

            } else {
                alert("ì—ëŸ¬");
            }

        });


        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ì • í¼ ìˆ¨ê¸°ê¸°
        // replyUpdateCancelBtnê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ê¸° ë•Œë¬¸ì— ë°”ë¡œ click ì“°ë©´ ì•ˆë˜ê³  on ì‚¬ìš©í•´ì•¼í•¨
        $(document).on("click", ".replyUpdateCancelBtn", function () {
            let replyId = $(this).data('reply-id');
            console.log("ë¦¬í”Œë¦¬ ì•„ì´ë”” " + replyId);

            $("#showReplyUpdateForm-" + replyId).show();
            $("#newShowReplyUpdateForm-" + replyId).remove();
        });


        // ê²Œì‹œê¸€ ì‚­ì œ
        $("#btn-delete").click(function (e) {

            Swal.fire({
                title: 'ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                icon: 'warning',

                showCancelButton: true, // cancelë²„íŠ¼ ë³´ì´ê¸°. ê¸°ë³¸ì€ ì›ë˜ ì—†ìŒ
                confirmButtonColor: '#3085d6', // confrim ë²„íŠ¼ ìƒ‰ê¹” ì§€ì •
                cancelButtonColor: '#d33', // cancel ë²„íŠ¼ ìƒ‰ê¹” ì§€ì •
                confirmButtonText: 'ì˜ˆ', // confirm ë²„íŠ¼ í…ìŠ¤íŠ¸ ì§€ì •
                cancelButtonText: 'ì•„ë‹ˆìš”', // cancel ë²„íŠ¼ í…ìŠ¤íŠ¸ ì§€ì •

            }).then(result => {
                // ë§Œì•½ Promiseë¦¬í„´ì„ ë°›ìœ¼ë©´,
                if (result.isConfirmed) { // ë§Œì•½ ëª¨ë‹¬ì°½ì—ì„œ confirm ë²„íŠ¼ì„ ëˆŒë €ë‹¤ë©´
                    Swal.fire('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', '', 'success')
                            .then(() => {
                                $.ajax({
                                    type: "POST",
                                    url: "/s/post/delete/{{model.postId}}",

                                }).done((res) => {
                                    // alert("Ddd");
                                    window.location.href = "/post/list";

                                }).fail((res) => {
                                    alert("ì‹¤íŒ¨");
                                });

                            });
                }
            });
        });
        // ê²Œì‹œê¸€ ì‚­ì œ


    </script>

{{>/layout/footer}}